name: Increment RC Branch

on:
  push:
    branches:
      - 'release/v*.*.*-rc*'

# Serialize RC branch creation to prevent race conditions
# when multiple commits are pushed to the same release branch rapidly
concurrency:
  group: increment-rc-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  increment-rc:
    name: Create Next RC Branch
    runs-on: ubuntu-latest
    outputs:
      next_branch: ${{ steps.branch_check.outputs.next_branch }}
      created: ${{ steps.branch_check.outputs.exists == 'false' }}
    
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Parse current branch and calculate next RC
        id: version
        run: |
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Current branch: $CURRENT_BRANCH"
          
          # Extract version and RC number from branch name
          # Format: release/v0.1.0-rc.1 (SemVer compliant)
          if [[ $CURRENT_BRANCH =~ release/v([0-9]+\.[0-9]+\.[0-9]+)-rc\.([0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            CURRENT_RC="${BASH_REMATCH[2]}"
            NEXT_RC=$((CURRENT_RC + 1))
            
            echo "Version: $VERSION"
            echo "Current RC: $CURRENT_RC"
            echo "Next RC: $NEXT_RC"
            
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "current_rc=$CURRENT_RC" >> $GITHUB_OUTPUT
            echo "next_rc=$NEXT_RC" >> $GITHUB_OUTPUT
            echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "âŒ Branch name does not match expected pattern: release/v*.*.*-rc*"
            exit 1
          fi
      
      - name: Check if next RC branch already exists
        id: branch_check
        run: |
          NEXT_BRANCH="release/v${{ steps.version.outputs.version }}-rc.${{ steps.version.outputs.next_rc }}"
          
          if git ls-remote --exit-code --heads origin "$NEXT_BRANCH" > /dev/null 2>&1; then
            echo "â„¹ï¸ Branch $NEXT_BRANCH already exists, skipping creation"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Branch $NEXT_BRANCH does not exist, will create"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          
          echo "next_branch=$NEXT_BRANCH" >> $GITHUB_OUTPUT
      
      - name: Create next RC branch
        if: steps.branch_check.outputs.exists == 'false'
        run: |
          NEXT_BRANCH="${{ steps.branch_check.outputs.next_branch }}"
          
          echo "Creating new RC branch: $NEXT_BRANCH"
          git checkout -b "$NEXT_BRANCH"
          
          # Push the new RC branch
          git push origin "$NEXT_BRANCH"
          
          echo "âœ… Release candidate branch created: $NEXT_BRANCH"
          echo "ðŸ“¦ Version: ${{ steps.version.outputs.version }}"
          echo "ðŸ”¢ RC Number: ${{ steps.version.outputs.next_rc }}"
          echo "ðŸ“ Base Branch: ${{ steps.version.outputs.current_branch }}"
          echo "ðŸ”— Branch URL: https://github.com/${{ github.repository }}/tree/$NEXT_BRANCH"
      
      - name: Create summary
        if: steps.branch_check.outputs.exists == 'false'
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ”„ Release Candidate Incremented
          
          - **Previous Branch**: \`${{ steps.version.outputs.current_branch }}\`
          - **New Branch**: \`${{ steps.branch_check.outputs.next_branch }}\`
          - **Version**: \`${{ steps.version.outputs.version }}\`
          - **Previous RC**: \`rc${{ steps.version.outputs.current_rc }}\`
          - **New RC**: \`rc${{ steps.version.outputs.next_rc }}\`
          
          ### What Happened
          
          A commit was pushed to the release branch \`${{ steps.version.outputs.current_branch }}\`.
          A new release candidate branch has been created with incremented RC number.
          
          ### Next Steps
          
          1. Test the new RC branch: \`${{ steps.branch_check.outputs.next_branch }}\`
          2. If more fixes are needed, merge them into the new RC branch
          3. Each merge will create another RC increment
          4. When ready for release, create PR from the latest RC to \`main\`
          
          ### Branch URL
          
          https://github.com/${{ github.repository }}/tree/${{ steps.branch_check.outputs.next_branch }}
          EOF
      
      - name: Skip summary
        if: steps.branch_check.outputs.exists == 'true'
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## â„¹ï¸ RC Branch Already Exists
          
          - **Current Branch**: \`${{ steps.version.outputs.current_branch }}\`
          - **Next Branch**: \`${{ steps.branch_check.outputs.next_branch }}\`
          - **Status**: Branch already exists, no action taken
          
          The next RC branch already exists. This is normal if multiple commits were pushed in quick succession.
          EOF

  # Trigger RC build after branch creation
  # Note: Push events from GITHUB_TOKEN don't trigger other workflows
  trigger-build:
    name: Trigger RC Build
    needs: increment-rc
    if: needs.increment-rc.outputs.created == 'true'
    uses: ./.github/workflows/build-rc.yml
    with:
      branch: ${{ needs.increment-rc.outputs.next_branch }}
    secrets: inherit
