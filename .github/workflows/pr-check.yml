name: PR Check

on:
  pull_request:
    branches:
      - main
      - develop
  # Allow manual trigger for testing
  workflow_dispatch:
  # Allow workflow to be called by other workflows
  workflow_call:

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25.2.1'
          cache: 'npm'
      
      - name: Install dependencies (root)
        run: npm ci
      
      - name: Install dependencies (frontend)
        run: npm ci
        working-directory: frontend
      
      - name: Install dependencies (backend)
        run: npm ci
        working-directory: backend
      
      - name: Install dependencies (shared)
        run: npm ci
        working-directory: shared
      
      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: backend
      
      - name: Build i18n types
        run: node ../scripts/build-i18n.cjs
        working-directory: frontend
      
      - name: Build Shared Package
        run: npm run build
        working-directory: shared
      
      - name: Run ESLint (Frontend)
        run: npm run lint
        working-directory: frontend
      
      - name: Run ESLint (Backend)
        run: npm run lint
        working-directory: backend
      
      - name: TypeScript type check (Frontend)
        run: npx tsc --noEmit
        working-directory: frontend
      
      - name: TypeScript type check (Backend)
        run: npx tsc --noEmit
        working-directory: backend
      
      - name: Validate Prisma schema
        run: npx prisma validate
        working-directory: backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/db
      
      - name: Check for migration drift
        run: |
          # Check if there are uncommitted migration files
          if [ -n "$(git status --porcelain backend/prisma/migrations)" ]; then
            echo "❌ Error: Uncommitted migration files detected"
            git status backend/prisma/migrations
            exit 1
          fi
          echo "✅ No migration drift detected"

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25.2.1'
          cache: 'npm'
      
      - name: Install dependencies (root)
        run: npm ci
      
      - name: Install dependencies (frontend)
        run: npm ci
        working-directory: frontend
      
      - name: Install dependencies (backend)
        run: npm ci
        working-directory: backend
      
      - name: Install dependencies (shared)
        run: npm ci
        working-directory: shared
      
      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: backend
      
      - name: Build i18n types
        run: node ../scripts/build-i18n.cjs
        working-directory: frontend
      
      - name: Build Shared Package
        run: npm run build
        working-directory: shared
      
      - name: Install Playwright browsers for Vitest
        run: npx playwright install chromium --with-deps
        working-directory: frontend
      
      - name: Build Frontend (Vite)
        run: npm run build
        working-directory: frontend
        env:
          VITE_API_URL: http://localhost:4000
          BUILD_TARGET: prod
      
      # Build backend with BUILD_TARGET=prod (demo code tree-shaken out)
      - name: Build Backend (tsup - Production)
        run: npm run build:prod
        working-directory: backend
        env:
          BUILD_TARGET: prod
      
      - name: Run tests with coverage (Frontend)
        run: npm run test:coverage
        working-directory: frontend
      
      - name: Run tests with coverage (Backend)
        run: npm run test:coverage
        working-directory: backend
      
      # Coverage is uploaded to Codecov on main branch merge (see coverage.yml)
      # PR coverage comment for visibility only
      - name: Comment coverage on PR
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: github.event_name == 'pull_request'
        with:
          lcov-file: ./frontend/coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true

  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25.2.1'
          cache: 'npm'
      
      # Build artifacts first (new COPY-only Dockerfile requires pre-built artifacts)
      - name: Build artifacts
        run: |
          # Install dependencies
          npm ci
          cd shared && npm ci && npm run build && cd ..
          cd backend && npm ci && npx prisma generate && cd ..
          cd frontend && npm ci && cd ..
          
          # Build with BUILD_TARGET=prod
          export BUILD_TARGET=prod
          cd frontend && npm run build && cd ..
          cd backend && npm run build:prod && cd ..
          
          # Prepare output directory structure for Docker build
          mkdir -p docker-build-output/backend
          mkdir -p docker-build-output/frontend
          mkdir -p docker-build-output/docker
          
          # Copy artifacts
          cp -r backend/dist docker-build-output/backend/
          cp -r backend/prisma docker-build-output/backend/
          cp backend/package.json docker-build-output/backend/
          cp backend/package-lock.json docker-build-output/backend/
          cp -r frontend/dist docker-build-output/frontend/
          
          # Copy docker entrypoint scripts
          cp docker/docker-entrypoint-allinone.sh docker-build-output/docker/
          cp docker/docker-entrypoint-backend.sh docker-build-output/docker/
          cp docker/docker-entrypoint-frontend.sh docker-build-output/docker/
          cp docker/nginx.conf docker-build-output/docker/
          
          # Install production dependencies for backend
          cd docker-build-output/backend
          npm ci --omit=dev
          npx prisma generate
          cd ../..
          
          echo "✅ Artifacts built successfully"
          ls -la docker-build-output/
          ls -la docker-build-output/backend/
          ls -la docker-build-output/frontend/
          ls -la docker-build-output/docker/
        env:
          BUILD_TARGET: prod
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Build Docker image from pre-built artifacts
      - name: Build Docker image (amd64 only)
        uses: docker/build-push-action@v5
        with:
          context: ./docker-build-output
          file: ./docker/Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: m3w:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Report build success
        run: |
          echo "✅ Docker image built successfully"
          docker images m3w:pr-${{ github.event.pull_request.number }} --format "Image: {{.Repository}}:{{.Tag}}, Size: {{.Size}}"

  pr-check-summary:
    name: PR Check Summary
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test, docker-build]
    if: always()
    
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.build-and-test.result }}" != "success" ] || \
             [ "${{ needs.docker-build.result }}" != "success" ]; then
            echo "❌ PR check failed"
            exit 1
          fi
          echo "✅ All PR checks passed!"
