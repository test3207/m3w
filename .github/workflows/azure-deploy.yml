name: Azure Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        type: choice
        options:
          - deploy
          - rollback
      revision:
        description: 'Revision name for rollback (leave empty for previous)'
        required: false
        type: string

concurrency:
  group: azure-deploy
  cancel-in-progress: false

env:
  AZURE_REGISTRY: m3wacr.azurecr.io
  IMAGE_NAME: m3w
  RESOURCE_GROUP: m3w-rg
  APP_NAME: m3w-app
  NODE_VERSION: '22'

jobs:
  # Pre-deployment checks (same as PR checks)
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.action == 'deploy'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: TypeScript type check
        run: npx tsc --noEmit
      
      - name: Validate Prisma schema
        run: npx prisma validate
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/db
      
      - name: Check for migration drift
        run: |
          # Check if there are uncommitted migration files
          if [ -n "$(git status --porcelain prisma/migrations)" ]; then
            echo "‚ùå Error: Uncommitted migration files detected"
            git status prisma/migrations
            exit 1
          fi
          echo "‚úÖ No migration drift detected"

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.action == 'deploy'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Build Next.js application
        run: npm run build
        env:
          # Mock environment variables for build
          DATABASE_URL: postgresql://mock:mock@localhost:5432/mock
          REDIS_URL: redis://localhost:6379
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: mock-secret-for-build-only
          GITHUB_CLIENT_ID: mock-client-id
          GITHUB_CLIENT_SECRET: mock-client-secret
          MINIO_ENDPOINT: localhost
          MINIO_PORT: 9000
          MINIO_ACCESS_KEY: minioadmin
          MINIO_SECRET_KEY: minioadmin
          MINIO_USE_SSL: false
          MINIO_BUCKET_NAME: m3w-music
      
      - name: Run tests with coverage
        run: npm run test -- --coverage
      
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: coverage/

  build-and-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test]
    if: github.event_name == 'push' || github.event.inputs.action == 'deploy'
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set image tag
        id: set-tag
        run: |
          TAG="${GITHUB_SHA::8}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è  Image tag: $TAG"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ steps.set-tag.outputs.tag }}
            ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  database-migration:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' || github.event.inputs.action == 'deploy'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Verify migration
        run: |
          echo "‚úÖ Database migrations completed"
          npx prisma migrate status
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  deploy:
    name: Deploy to Container Apps
    runs-on: ubuntu-latest
    needs: [build-and-push, database-migration]
    if: github.event_name == 'push' || github.event.inputs.action == 'deploy'
    environment:
      name: production
      url: ${{ steps.get-url.outputs.app-url }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy new revision
        run: |
          az containerapp update \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }} \
            --set-env-vars \
              NODE_ENV=production \
              DATABASE_URL=secretref:database-url \
              AZURE_STORAGE_CONNECTION_STRING=secretref:azure-storage-connection-string \
              AZURE_STORAGE_CONTAINER_NAME=music \
              NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
              NEXTAUTH_SECRET=secretref:nextauth-secret \
              GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }} \
              GITHUB_CLIENT_SECRET=secretref:github-client-secret
      
      - name: Get application URL
        id: get-url
        run: |
          APP_URL=$(az containerapp show \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          echo "app-url=https://$APP_URL" >> $GITHUB_OUTPUT
          echo "üöÄ Deployed to: https://$APP_URL"
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.get-url.outputs.app-url }}/api/health" || echo "000")
            if [ "$STATUS" == "200" ]; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            echo "‚è≥ Waiting for app to be ready (attempt $i/5)..."
            sleep 10
          done
          echo "‚ùå Health check failed"
          exit 1

  rollback:
    name: Rollback to Previous Revision
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'rollback'
    environment:
      name: production-rollback
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Get current and previous revisions
        id: revisions
        run: |
          echo "üìã Listing all revisions..."
          az containerapp revision list \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[].{Name:name, Active:properties.active, Created:properties.createdTime}" \
            --output table
          
          if [ -n "${{ github.event.inputs.revision }}" ]; then
            PREV_REVISION="${{ github.event.inputs.revision }}"
          else
            PREV_REVISION=$(az containerapp revision list \
              --name ${{ env.APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --query "[?properties.active==\`true\`] | [1].name" \
              --output tsv)
          fi
          
          if [ -z "$PREV_REVISION" ]; then
            echo "‚ùå No previous revision found"
            exit 1
          fi
          
          echo "revision=$PREV_REVISION" >> $GITHUB_OUTPUT
          echo "üîÑ Will rollback to: $PREV_REVISION"
      
      - name: Activate previous revision
        run: |
          az containerapp revision activate \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision ${{ steps.revisions.outputs.revision }}
          
          echo "‚úÖ Rollback completed to revision: ${{ steps.revisions.outputs.revision }}"
      
      - name: Verify rollback
        run: |
          sleep 20
          APP_URL=$(az containerapp show \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$APP_URL/api/health" || echo "000")
          if [ "$STATUS" == "200" ]; then
            echo "‚úÖ Rollback verified successfully"
          else
            echo "‚ö†Ô∏è  Warning: Health check returned status $STATUS"
          fi

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test, deploy]
    if: always() && (github.event_name == 'push' || github.event.inputs.action == 'deploy')
    
    steps:
      - name: Report Status
        run: |
          if [ "${{ needs.code-quality.result }}" != "success" ]; then
            echo "‚ùå Code quality checks failed - deployment aborted"
            exit 1
          elif [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "‚ùå Build and tests failed - deployment aborted"
            exit 1
          elif [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ All checks passed and deployment completed successfully"
            echo "üè∑Ô∏è  Image tag: ${{ needs.build-and-push.outputs.image-tag }}"
          else
            echo "‚ùå Deployment failed after passing all checks"
            echo "üí° You can rollback using: workflow_dispatch with action=rollback"
          fi
